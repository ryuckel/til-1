# Lambda

以下をトリガーにして関数を実行できる

- S3 へのファイル保存
- DynamoDB のデータ変更
- SQS キューにメッセージが追加される
- APIGateway に HTTP リクエストが送信される
- AWS SDK を用いたモバイルアプリから関数が呼び出される

## イベントソース

- Push

同期呼び出し：処理を完了して結果をレスポンスとして返す
非同期呼び出し：実行命令だけ送って処理の完了は待たない

- Pull

DynamoDB、Kinesis Stream をトリガーとするストリームベース
SQS のキューをトリガーとするキューベース

画像

## 関数の作成

1. マネジメントコンソールから直接入力する
2. マネジメントコンソールの Lambda の画面上で ZIP ファイルをアップロードする
3. S3 に ZIP ファイルをアップロードして参照させる

## 対応言語

Node.js,Python,Go,Ruby,.NET
それ以外の言語もカスタムランタイムで利用することができる

## ライブラリの利用

ZIP 化して Lambda にアップロードする必要がある。
コードは必ずルートディレクトリに含める

## Lambda レイヤー

複数の Lambda 関数でコードを共有する(共通機能を作って使いまわせる)
1 つの Lambda 関数で 5 妻で指定することができる

## Lambda 関数の基本設定

メモリは 128~3008MB まで指定され、比例する CPU が割り当てられる
タイムアウトは最長で 15 分

## Lambda 関数の環境変数

処理に応じて関数内の変数の値を変えたい場合は環境変数を定義して参照する
DB の接続情報など

## Lambda 関数の同時実行数とスロットリング

ある時点で同時に実行されている Lambda 関数の数
同一アカウント同一リージョンにつき 1000 件まで

上限に達するとスロットリングされて実行されない
イベントのソースによって処理方法が変わる

画像

## Lambda 関数のリトライ

失敗してリトライするときの処理

画像

## Lambda 関数ポリシーと実行ロール

- Lambda 関数ポリシー
  リソースベースのポリシー
  S3 などに対して割り当てる

- 実行ロール(IAM ロール)
  Lambda 関数に対して割ああてて
  cloudwatch Logs や SQS などのプル型のイベントソースへのアクセス権限を付与する

## VPC アクセス

VPC 内の EC2 や RDS インスタンスに対してアクセスするためには VPC アクセス設定が必要

## Lambda 関数のデバッグ

CloudWatch Logs から紐解く
SAM を使えばローカルで実行して、デバッグも可能

## バージョンとエイリアス

- バージョン
  \$LATEST が関数作成時に付与されて、＄ LATEST 以外のバージョンは
  スナップショットとして発行される
  LATEST 以外のバージョンの ARN は末尾にバージョン番号がつく

- エイリアス
  Lambda 関数の各バージョンに名前をつける
  ARN の末尾につく

→ 更新などでバージョン番号が変わっても Lambda 関数を呼び出すコードを変更する必要がない

## コールドスタートとウォームスタート

## モニタリング

- CloudWatch Logs
  アクセス権限を付与すれば利用可能

- X-Ray
  アプリケーションのパフォーマンス分析、エラー原因特定
  CloudWatch よりも詳細な分析が可能

関数の準備時間、DynamoDB,S3 の呼び出しにかかった時間も計測して可視化してくれる

以下の準備が必要

1. トレースモードをアクティブにする。実行ロールには X-Ray の書き込みに必要な権限が自動的に付与される
2. AWS サービスの呼び出しをモニタリングするには、Lambda 関数のコード内でサブセグメントを発行し、トレースを有効化する

X-Ray を使用する場合は X-Ray デーモンが作動して割り当てられたメモリの一部を消費する

# API GateWay
