# Lambda

以下をトリガーにして関数を実行できる

- S3 へのファイル保存
- DynamoDB のデータ変更
- SQS キューにメッセージが追加される
- APIGateway に HTTP リクエストが送信される
- AWS SDK を用いたモバイルアプリから関数が呼び出される

## イベントソース

- Push

同期呼び出し：処理を完了して結果をレスポンスとして返す
非同期呼び出し：実行命令だけ送って処理の完了は待たない

- Pull

DynamoDB、Kinesis Stream をトリガーとするストリームベース
SQS のキューをトリガーとするキューベース


![スクリーンショット 2020-06-02 13 27 16](https://user-images.githubusercontent.com/36391432/83480583-c8f9eb80-a4d6-11ea-9f70-11bb4422f32e.png)

## 関数の作成

1. マネジメントコンソールから直接入力する
2. マネジメントコンソールの Lambda の画面上で ZIP ファイルをアップロードする
3. S3 に ZIP ファイルをアップロードして参照させる

## 対応言語

Node.js,Python,Go,Ruby,.NET
それ以外の言語もカスタムランタイムで利用することができる

## ライブラリの利用

ZIP 化して Lambda にアップロードする必要がある。
コードは必ずルートディレクトリに含める

## Lambda レイヤー

複数の Lambda 関数でコードを共有する(共通機能を作って使いまわせる)
1 つの Lambda 関数で 5 妻で指定することができる

## Lambda 関数の基本設定

メモリは 128~3008MB まで指定され、比例する CPU が割り当てられる
タイムアウトは最長で 15 分

## Lambda 関数の環境変数

処理に応じて関数内の変数の値を変えたい場合は環境変数を定義して参照する
DB の接続情報など

## Lambda 関数の同時実行数とスロットリング

ある時点で同時に実行されている Lambda 関数の数
同一アカウント同一リージョンにつき 1000 件まで

上限に達するとスロットリングされて実行されない
イベントのソースによって処理方法が変わる

![スクリーンショット 2020-06-02 13 27 02](https://user-images.githubusercontent.com/36391432/83480588-cbf4dc00-a4d6-11ea-83a6-32f514df2fd9.png)

## Lambda 関数のリトライ

失敗してリトライするときの処理

![スクリーンショット 2020-06-02 13 26 56](https://user-images.githubusercontent.com/36391432/83480591-cc8d7280-a4d6-11ea-987c-08114a0d8007.png)

## Lambda 関数ポリシーと実行ロール

- Lambda 関数ポリシー
  リソースベースのポリシー
  S3 などに対して割り当てる

- 実行ロール(IAM ロール)
  Lambda 関数に対して割ああてて
  cloudwatch Logs や SQS などのプル型のイベントソースへのアクセス権限を付与する

## VPC アクセス

VPC 内の EC2 や RDS インスタンスに対してアクセスするためには VPC アクセス設定が必要

## Lambda 関数のデバッグ

CloudWatch Logs から紐解く
SAM を使えばローカルで実行して、デバッグも可能

## バージョンとエイリアス

- バージョン
  \$LATEST が関数作成時に付与されて、＄ LATEST 以外のバージョンは
  スナップショットとして発行される
  LATEST 以外のバージョンの ARN は末尾にバージョン番号がつく

- エイリアス
  Lambda 関数の各バージョンに名前をつける
  ARN の末尾につく

→ 更新などでバージョン番号が変わっても Lambda 関数を呼び出すコードを変更する必要がない

## コールドスタートとウォームスタート

## モニタリング

- CloudWatch Logs
  アクセス権限を付与すれば利用可能

- X-Ray
  アプリケーションのパフォーマンス分析、エラー原因特定
  CloudWatch よりも詳細な分析が可能

関数の準備時間、DynamoDB,S3 の呼び出しにかかった時間も計測して可視化してくれる

以下の準備が必要

1. トレースモードをアクティブにする。実行ロールには X-Ray の書き込みに必要な権限が自動的に付与される
2. AWS サービスの呼び出しをモニタリングするには、Lambda 関数のコード内でサブセグメントを発行し、トレースを有効化する

X-Ray を使用する場合は X-Ray デーモンが作動して割り当てられたメモリの一部を消費する

# API GateWay
RESTful,WebSocketAPIの作成、管理

## APIの作成

![スクリーンショット 2020-06-02 13 44 47](https://user-images.githubusercontent.com/36391432/83480806-4160ac80-a4d7-11ea-8f9c-a47e11c33031.png)

## APIの公開

![スクリーンショット 2020-06-02 13 45 08](https://user-images.githubusercontent.com/36391432/83480829-4a517e00-a4d7-11ea-9772-ac2aa55c30c5.png)

## APIドキュメント

ドキュメント作成の機能を使用すると
ソース、メソッド、リクエスト、レスポンスの説明をつけるだけでSwaggerの標準的な形式に沿ったAPIドキュメント定義ファイルをエクスポートできる

Swagger形式のドキュメント定義ファイルをAPIGateWayにインポートしてAPIの作成を開始することも可能

## APIの管理

### アクセス制御
- リソースポリシー
JSON形式で定義してリソースとアクションを制限することができる
 (任意のAWSアカウントのIAMユーザー、IP、VPCエンドポイント)
- IAM認証
APIの各要素へのアクセス権限を設定したIAMポリシーを作成し、IAMユーザーやIAMロールに付与することで、APIへのアクセスの制御が可能になります。
これには、対象の各APIメソッドでIAM認証を有効化する必要があります。
- Lambdaオーソライザー
Lambdaオーソライザーと呼ばれるLambda関数を作成することで、認証プロバイダーでの認証結果をもとに、APIへのアクセス制御をメソッド単位で行えるようになります。
- Cognitoオーソライザー
認証プロバイダーとしてCognitoユーザープールを用いて、APIへのアクセス制御をメソッド単位で行うことも可能です。
Lambda関数の作成の必要はない

### スロットリング
メソッド単位とAPIKey単位で設定できる
スロットリング設定では、レート（1秒あたりのリクエスト数）とバースト（リクエストの同時実行数）を設定します。

- 使用プランとAPIキー
APIキーとは、APIGatewayの使用量を制限するために発行するアクセスキー
APIキーの使用量制限はそれぞれのAPIキーに対して設定するのではなく、使用量プランという設定項目でスロットリング設定を行い、APIキーを使用量プランに紐づけることで設定します。

レートやバーストの他に、クォータ（日、週、月あたりのリクエスト数）も設定します。


### モニタリング

CloudWatchやCloudTrail、そしてXRayと連携して監視を行うことができます。また、標準でマネージメントコンソール上にAPIGatewayダッシュボードが用意されており、
各APIの利用状況をステージごとに可視化して確認することができます。現在、標準で確認できる項目は、以下のとおりです。

- API呼び出し（数）
- キャッシュヒット（APIキャッシュが有効になっている場合のみ）
- キャッシュミス（APIキャッシュが有効になっている場合のみ）
- レイテンシー
- 統合のレイテンシー
- 4XXエラー（数）
- 5XXエラー（数）

### 攻撃からの保護
